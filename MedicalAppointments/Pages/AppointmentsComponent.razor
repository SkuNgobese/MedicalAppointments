@page "/Appointments"

<h2 class="text-2xl font-bold mb-4">Appointments</h2>

<button class="btn btn-primary mb-4" @onclick="ShowBookModal">Book Appointment</button>

@if (appointments is not null && appointments.Any())
{
    <ul class="space-y-4">
        @foreach (var appointment in appointments)
        {
            <li class="p-4 border rounded shadow-sm bg-white">
                <div class="flex justify-between items-center">
                    <div>
                        <p class="font-semibold">@appointment.PatientViewModel!.FullName
                            @if (appointment.PatientViewModel.ContactDetails != null)
                            {
                                <span> - @appointment.PatientViewModel.ContactDetails.ContactNumber</span> 
                                <a> - @appointment.PatientViewModel.ContactDetails!.Email</a>
                            }
                        </p>
                        <p>
                            With <strong>@appointment.DoctorViewModel!.FullName</strong> on
                            <strong>@appointment.Date.ToString("f")</strong>
                        </p>
                    </div>
                    <div class="space-x-2">
                        <button class="btn btn-danger" @onclick="() => CancelAppointment(appointment.Id)">Cancel</button>
                        <button class="btn btn-warning" @onclick="() => ShowRescheduleModal(appointment)">Reschedule</button>
                        <button class="btn btn-secondary" @onclick="() => ShowReassignModal(appointment)">Reassign</button>
                    </div>
                </div>
            </li>
        }
    </ul>
}
else
{
    <p>No appointments found.</p>
}

@* Reschedule Modal *@
@if (rescheduleModalVisible)
{
    <div class="modal-overlay">
        <div class="modal-content">
            <h3 class="text-lg font-bold mb-2">Reschedule Appointment</h3>
            <input type="datetime-local" @bind="rescheduleDate" class="form-control mb-2" />
            <button class="btn btn-primary" @onclick="ConfirmReschedule">Save</button>
            <button class="btn btn-outline" @onclick="CloseRescheduleModal">Cancel</button>
        </div>
    </div>
}

@* Reassign Modal *@
@if (reassignModalVisible)
{
    <div class="modal-overlay">
        <div class="modal-content">
            <h3 class="text-lg font-bold mb-2">Reassign Appointment</h3>
            <select class="form-control mb-2" @bind="selectedDoctorId">
                <option disabled value="">-- Select Doctor --</option>
                @foreach (var doc in allDoctors)
                {
                    <option value="@doc.Id">@doc.FullName</option>
                }
            </select>
            <button class="btn btn-primary" @onclick="ConfirmReassign">Save</button>
            <button class="btn btn-outline" @onclick="CloseReassignModal">Cancel</button>
        </div>
    </div>
}

@if (bookModalVisible)
{
    <div class="modal-overlay">
        <div class="modal-content">
            <h3 class="text-lg font-bold mb-2">Book New Appointment</h3>

            <input class="form-control mb-2" placeholder="Patient ID Number or Contact Number" @bind="searchTerm" />
            <button class="btn btn-outline mb-2" @onclick="SearchPatient">Search Patient</button>

            @if (patientNotFound)
            {
                <div class="mb-2">
                    <InputSelect class="form-control mb-2" @bind-Value="newPatient.Title">
                        @foreach (var title in titles)
                        {
                            <option value="@title">@title</option>
                        }
                    </InputSelect>
                    <input class="form-control mb-2" placeholder="First Name" @bind="newPatient.FirstName" />
                    <input class="form-control mb-2" placeholder="Last Name" @bind="newPatient.LastName" />
                    <input class="form-control mb-2" placeholder="ID Number" @bind="newPatient.IDNumber" />
                    <input class="form-control mb-2" placeholder="Contact Number" @bind="newPatient.ContactDetails!.ContactNumber" />
                    <input class="form-control mb-2" placeholder="Email" @bind="newPatient.ContactDetails.Email" />
                </div>
            }

            <InputSelect class="form-control mb-2" @bind-value="selectedDoctorId">
                <option value="">-- Select Doctor --</option>
                @foreach (var doc in allDoctors)
                {
                    <option value="@doc.Id">@doc.FullName</option>
                }
            </InputSelect>

            <InputText class="form-control mb-2" @bind-value="newAppointment.Description" />
            <input type="datetime-local" class="form-control mb-2" @bind-value="newAppointment.Date" />

            <button class="btn btn-primary" @onclick="ConfirmBooking">Book</button>
            <button class="btn btn-outline" @onclick="CloseBookModal">Cancel</button>
        </div>
    </div>
}